---
title: "Figure 1"
output: html_document
date: "2024-11-14"
---

#load libraries
```{r}
library(devtools)
library(ggplot2)
library(ggpubr)
library(damr)
library(zeitgebr)
library(ggetho)
library(sleepr)
library(dplyr)
library(viridis)
library(knitr)
library(here)
```

#Clear workspace
```{r}
rm(list = ls())
```

#check working direcetory
```{r}
getwd()
```
#store path variable for genotype DGRP852
```{r}
DATA_DIR <- "/Users/anabelbyars/Desktop/Riddle Lab/Circadian analysis"
```
#check all files are present
```{r}
list.files(DATA_DIR, pattern="*.txt|*.csv")
```

#Define metavariables for the corresponding legend within each genotype
```{r}
data <- fread("metadata.csv")
data
```

#Link meta data based on genotype
```{r}
metadata <- link_dam_metadata(data, result_dir = DATA_DIR)
metadata
```
#Load into a behavr structure
Exclude mated animals not under "OK" status, find and load matching data
```{r}
dt <- load_dam(metadata[status == "OK"])
summary(dt)
```
#Rejoin data and divide by counts
```{r}
dt <- rejoin(dt)
dt[, "nd"] <- dt[, "activity"] / dt[, "counts"]
```
#Turn back into behavr table
```{r}
dt <- behavr(dt, metadata [status == "OK"])
```
#Make 0 the start 7AM lights on time point
```{r}
dt[,t := t - hours(xmv(baseline_time))]
```

#select controls
```{r}
genotype_controls <-dt[c(7201:16128, 61633:69408, 129889:139104, 253441:262368)]
```

#run the plot
```{r}
graph_controls <- ggetho(genotype_controls, aes(x = t, y = nd, colour = treatment)) + 
  stat_pop_etho() + 
  facet_grid(sex ~ genotype) +
  labs(y = "Activity per fly", x = "Time (h)") + 
  theme_bw() +
  scale_color_manual(values = c("purple"), name = "Treatment") +
  scale_fill_manual(values = c("purple"), name = "Treatment") +
  theme(strip.background = element_rect(fill = "white"), 
        strip.text = element_text(colour = "black"),
        panel.grid.major = element_blank(),
        ) +
  annotate('rect', xmin = -28800, xmax = 0, ymin = 0, ymax = 12, alpha = 0.3, fill = "darkgrey") +
  annotate('rect', xmin = 43200, xmax = 64800, ymin = 0, ymax = 12, alpha = 0.3, fill = "darkgrey")

graph_controls

```

#Statistical analysis for the control graph
```{r}
ks_test_result_c <- ks.test(genotype_controls$nd, "pnorm", mean = mean(genotype_controls$nd), sd = sd(genotype_controls$nd))
print(ks_test_result_c)

```
#Ranked ANOVA and Tukey test
```{r}
a_controls <- genotype_controls[order(genotype_controls$nd), ]
a_controls$rank <- 1:nrow(a_controls)
anova_result <- aov(rank ~ genotype * sex, data = a_controls)
summary(anova_result)

genotype_controls$genotype <- as.factor(genotype_controls$genotype)
genotype_controls$sex <- as.factor(genotype_controls$sex)

t1_controls <- TukeyHSD(anova_result, conf.level=0.95)
t1_controls
```

